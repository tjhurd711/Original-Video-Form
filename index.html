<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customize Your Memorial Video</title>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" 
        href="https://www.dropbox.com/scl/fi/7tqrvmnchu17tkatqa9l5/MemorialVideoAI-Favicon.svg?rlkey=5cj4gwyhq3frrupo1g1d3y8so&st=znzwkpy9&raw=1">
</head>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #d0a789;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(180deg, #1e3c72 0%, #2a298 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 12px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 16px;
      line-height: 1.5;
    }

    .header-logo {
      max-width: 500px;
      height: auto;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    
    .content {
      padding: 40px 30px;
    }
    
    .intro-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-left: 4px solid #667eea;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      line-height: 1.7;
      position: relative;  /* Added */
      z-index: 1;          /* Added */
    }
    
    .intro-box h2 {
      color: #667eea;
      font-size: 20px;
      margin-bottom: 12px;
    }
    
    .section {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.3s;
    }
    
    .section:hover {
      border-color: #2a298;
      box-shadow: 0 4px 12px rgba(42, 82, 12, 0.1);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .section-icon {
      font-size: 28px;
    }
    
    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 15px;
    }
    
    .form-group .help-text {
      font-size: 13px;
      color: #777;
      font-weight: 400;
      margin-top: 6px;
      line-height: 1.4;
    }
    
    .form-group select,
    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group input[type="url"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    
    .radio-option:hover {
      border-color: #2a5298;
      background: #f8f9ff;
    }
    
    .radio-option.selected {
      border-color: #2a5298;
      background: #f8f9ff;
    }
    
    .radio-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-top: 1px;
      flex-shrink: 0;
    }
    
    .radio-option-content {
      flex: 1;
    }
    
    .radio-option-label {
      font-weight: 600;
      display: inline-block;
      font-size: 15px;
      line-height: 20px;
      vertical-align: top;
    }
    
    .radio-option-desc {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
      display: block;
      margin-top: 4px;
    }
    
    .conditional-input {
      margin-top: 12px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    
    .info-box {
      padding: 16px;
      background: #fff9e6;
      border-left: 4px solid #FFC107;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #886600;
      line-height: 1.5;
    }
    
    .info-box.blue {
      background: #e3f2fd;
      border-left-color: #2196F3;
      color: #1565c0;
    }
    
    /* Transition Section Layout */
    .transition-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    
    .transition-dropdown {
      flex: 0 0 280px;
    }
    
    .transition-preview {
      flex: 1;
    }
    
    /* Song Library */
    .library-section {
      background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%);
      border: 2px solid #FF9800;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .library-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: 700;
      color: #e65100;
    }
    
    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    
    .library-song-card {
      background: white;
      border: 2px solid #FFE0B2;
      border-radius: 10px;
      padding: 12px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .library-song-card:hover {
      border-color: #FF9800;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
      transform: translateY(-2px);
    }
    
    .library-song-card.added {
      border-color: #4CAF50;
      background: #f1f8f4;
    }
    
    .library-song-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      line-height: 1.3;
    }
    
    .library-song-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .btn-play {
      background: #2196F3;
      color: white;
      min-width: 110px;
      flex-shrink: 0;
    }
    
    .btn-play:hover {
      background: #0b7dda;
    }
    
    .btn-play.playing {
      background: #FF9800;
    }
    
    .btn-add-library {
      flex: 0 0 auto;
      min-width: 95px;
      padding: 8px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .btn-add-library:hover:not(:disabled) {
      background: #f57c00;
    }
    
    .btn-add-library:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-add-library.added {
      background: #4CAF50;
    }

    
    
    /* Song List */
    .song-list {
      margin-bottom: 20px;
    }
    
    .song-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    
    .song-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    .song-item.new-upload {
      border-color: #4CAF50;
      background: #f1f8f4;
    }
    
    .song-item.library-song {
      border-color: #FF9800;
      background: #fff9f0;
    }
    
    .song-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    
    .song-position {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .song-name {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .song-badge {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .song-badge.library {
      background: #FF9800;
    }
    
    .song-controls {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    
    .btn-move {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }
    
    .btn-move:hover {
      background: #e0e0e0;
    }
    
    .btn-move:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-danger:hover {
      background: #d32f2f;
    }
    
    .upload-section {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 2px dashed #ccc;
    }
    
    .upload-section.max-reached {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .upload-label:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .upload-label.disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Presentation Preview */
    .preview-section {
      margin-top: 15px;
      padding: 20px;
      background: #f0f7ff;
      border: 2px solid #2196F3;
      border-radius: 8px;
    }
    
    .preview-header {
      font-weight: 600;
      color: #1565c0;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .preview-iframe {
      width: 100%;
      height: 400px;
      border: 2px solid #90caf9;
      border-radius: 8px;
      background: white;
    }
    
    .preview-url {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      font-size: 13px;
      color: #666;
      word-break: break-all;
    }
    
    /* Submit Button */
    .submit-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 3px solid #e0e0e0;
      text-align: center;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 20px 50px;
      font-size: 20px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
    }
    
    .btn-submit:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(30, 60, 114, 0.5);
    }
    
    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .submit-note {
      margin-top: 15px;
      color: white;
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      max-width: 400px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: #4CAF50;
    }
    
    .toast.error {
      background: #f44336;
    }

    /* Calculation Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 30px;
      border-radius: 16px 16px 0 0;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }
    
    .modal-body {
      padding: 30px;
    }
    
    .calc-result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f8f9ff;
      border-radius: 8px;
      margin-bottom: 16px;
      border: 2px solid #e0e0e0;
    }
    
    .calc-label {
      font-weight: 600;
      color: #555;
      font-size: 16px;
    }
    
    .calc-value {
      font-weight: 700;
      color: #2a5298;
      font-size: 20px;
    }
    
    .calc-summary {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-left: 4px solid #667eea;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      font-size: 15px;
      line-height: 1.6;
      color: #333;
    }
    
    .modal-footer {
      padding: 20px 30px 30px 30px;
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }
    
    .modal-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .modal-btn-secondary {
      background: #e0e0e0;
      color: #555;
    }
    
    .modal-btn-secondary:hover {
      background: #d0d0d0;
      transform: translateY(-2px);
    }
    
    .modal-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* Music Upload Terms Modal */
    .terms-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .terms-modal-overlay.show {
      display: flex;
    }

    .terms-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    .terms-modal-header {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      padding: 24px;
      border-radius: 16px 16px 0 0;
      text-align: center;
    }

    .terms-modal-header h2 {
      font-size: 24px;
      margin: 0;
    }

    .terms-modal-body {
      padding: 30px;
      line-height: 1.8;
      color: #333;
      font-size: 15px;
    }

    .terms-modal-footer {
      padding: 20px 30px;
      display: flex;
      gap: 12px;
      border-top: 2px solid #f0f0f0;
    }

    .terms-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

   .terms-btn-cancel {
     background: #f44336;
     color: white;
   }

   .terms-btn-cancel:hover {
     background: #d32f2f;
   }

   .terms-btn-accept {
     background: #4CAF50;
     color: white;
   }

   .terms-btn-accept:hover {
     background: #45a049;
   }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .loading-overlay.show {
      display: flex;
    }
    
    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      max-width: 400px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .loading-subtext {
      font-size: 14px;
      color: #666;
    }

    .loading-subtext {
      font-size: 14px;
      color: #666;
    }
    
    /* Song Range Sliders */
    .song-ranges-container {
      margin-top: 15px;
    }

    .song-range-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .song-range-header {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slide-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .slide-input-group {
      display: flex;
      flex-direction: column;
    }

    .slide-input-group label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .slide-input-group input {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .slide-input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 26px; }
      .section { padding: 20px; }
      .content { padding: 20px 15px; }
      
      /* Force song library to single column */
      .library-grid { 
        grid-template-columns: 1fr !important; 
      }
      
      /* Stack slide inputs vertically */
      .slide-inputs { 
        grid-template-columns: 1fr !important; 
      }
      
      /* Wrap song controls */
      .song-controls { 
        flex-wrap: wrap;
        gap: 8px;
      }
      
      /* Smaller buttons on mobile */
      .btn-small {
        min-width: 70px;
        padding: 6px 8px;
        font-size: 12px;
      }
      
      .btn-play {
        min-width: 90px !important;
      }
      
      .btn-add-library {
        min-width: 75px !important;
      }

      /* Make library card controls stack */
      .library-song-card {
        padding: 12px 8px;
      }
      
      .library-song-controls {
        flex-direction: column;
        gap: 6px;
      }
      
      .library-song-controls .btn-small,
      .library-song-controls .btn-add-library {
        width: 100%;
        min-width: unset;
      }
      
      /* Stack transition section vertically */
      .transition-container {
        flex-direction: column !important;
      }
      
      .transition-dropdown,
      .transition-preview {
        flex: 1 1 100% !important;
        max-width: 100% !important;
      }
      
      /* Toast notifications */
      .toast { 
        right: 10px; 
        left: 10px; 
        max-width: none; 
      }
      
      /* Modal improvements */
      .modal-content {
        width: 95%;
        margin: 10px;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.dropbox.com/scl/fi/i5ye9vg5wzfvxwyrwczq6/Untitled-940-x-600-px-1400-x-600-px.png?rlkey=rk5t9ot5gchvjcqx71lwiln1o&st=8orea38d&dl=1" alt="Memorial Video Logo" class="header-logo">
      <h1 id="headerTitle">‚ú® Customize Your Memorial Video</h1>
      <p>Review your final slideshow and choose your video preferences below</p>
    </div>
    
    <div class="content">
      <div class="intro-box">
        <h2>üìã Next Steps</h2>
        <p>We've created a draft slideshow from your photos. Please select your video settings below and confirm that we have your final slideshow link. Once you submit, we'll create your memorial video and send it to you via email in 5-15 minutes.</p>
      </div>
      
      <!-- SECTION 1: Slideshow Confirmation -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <span class="section-title">Confirm Your Slideshow</span>
        </div>
        
        <div class="info-box blue">
          We've prepared a draft slideshow for you. Please confirm which version you'd like to use for your video.
        </div>
        
        <div class="form-group">
          <label>
            Did you edit the document using the link shared by MemorialVideo.AI? Or, did you make a copy/download a separate version?
            <div class="help-text">Note: If you did not actively press "make a copy" or "download", then you likely edited the slideshow document provided.</div>
          </label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="slideshowVersion" value="original" checked>
              <span class="radio-option-label">I edited the document using the link provided</span>
              <div class="radio-option-content">
                <span class="radio-option-desc">Use the original slideshow that was shared</span>
              </div>
            </label>
            
            <label class="radio-option">
              <input type="radio" name="slideshowVersion" value="copy">
              <span class="radio-option-label">I made a Goolge Slides copy and have a new link</span>
              <div class="radio-option-content">
                <span class="radio-option-desc">Provide a new Google Slides URL (e.g., slideshow_v2)</span>
                <div class="conditional-input" id="copyUrlInput" style="display:none;">
                  <label for="newGoogleSlidesUrl" style="font-size: 13px; margin-bottom: 6px;">New Google Slides URL:</label>
                  <input type="url" id="newGoogleSlidesUrl" name="newGoogleSlidesUrl" placeholder="https://docs.google.com/presentation/d/...">
                </div>
              </div>
            </label>
            
            <label class="radio-option">
              <input type="radio" name="slideshowVersion" value="download">
              <span class="radio-option-label">I downloaded a version to my PC/have a new powerpoint URL</span>
              <div class="radio-option-content">
                <span class="radio-option-desc">Upload your PowerPoint file (.pptx) or provide a PowerPoint URL</span>
                <div class="conditional-input" id="downloadInput" style="display:none;">
                  <!-- Sub-choice: File or URL -->
                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 14px; font-weight: 600; color: #555; display: block; margin-bottom: 8px;">How would you like to provide your PowerPoint?</label>
                    
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                      <input type="radio" name="pptxMethod" value="file" style="width: 18px; height: 18px;">
                      <span style="font-weight: 600; font-size: 14px;">Upload File</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;">
                      <input type="radio" name="pptxMethod" value="url" style="width: 18px; height: 18px;">
                      <span style="font-weight: 600; font-size: 14px;">Provide URL</span>
                    </label>
                  </div>
                  
                  <!-- File Upload Section -->
                  <div id="pptxFileSection" style="display:none; margin-bottom: 12px;">
                    <label for="pptxFile" style="font-size: 13px; margin-bottom: 6px; display: block;">Upload PowerPoint File:</label>
                    <input type="file" id="pptxFile" name="pptxFile" accept=".pptx,application/vnd.openxmlformats-officedocument.presentationml.presentation">
                  </div>
                  
                  <!-- URL Section -->
                  <div id="pptxUrlSection" style="display:none;">
                    <label for="pptxUrl" style="font-size: 13px; margin-bottom: 6px; display: block;">PowerPoint URL (OneDrive/SharePoint):</label>
                    <input type="url" id="pptxUrl" name="pptxUrl" placeholder="https://onedrive.live.com/... or https://sharepoint.com/...">
                  </div>
                </div>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Slideshow Preview (Conditional) -->
        <div id="slideshowPreview" class="preview-section" style="display:none;">
          <div class="preview-header" id="previewHeader">
            üîç Preview: Slideshow
          </div>
          <iframe id="previewIframe" class="preview-iframe" src="" frameborder="0"></iframe>
          <div style="margin-top: 20px; text-align: center;">
            <a id="editSlidesButton" href="" target="_blank" 
               style="display: inline-block; 
                      padding: 14px 28px; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      color: white; 
                      text-decoration: none; 
                      border-radius: 8px; 
                      font-weight: 600; 
                      font-size: 16px;
                      transition: all 0.3s;
                      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);"
               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
              üé® Edit My Slides (edits will auto-save)
            </a>
          </div>
        
        
        <!-- PowerPoint File Preview (Filename only) -->
        <div id="pptxFilePreview" class="preview-section" style="display:none; background: #fff9e6; border-color: #FF9800;">
          <div class="preview-header" style="color: #e65100;">
            üìÑ PowerPoint File Selected
          </div>
          <div style="padding: 15px; background: white; border-radius: 8px; font-weight: 600; color: #333;">
            <span id="pptxFileName"></span>
          </div>
        </div>
      </div>
      
      <!-- SECTION 2: Choose Music -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üéµ</span>
          <span class="section-title">Choose Your Music</span>
        </div>
        
        <div class="library-section">
          <div class="library-header">
            üéº Select Royalty Free Songs to add to your video (you can update the song order below)
          </div>
          <div style="margin-bottom: 15px;">
            <label for="genreSelect" style="font-weight: 600; color: #e65100; margin-bottom: 6px; display: block;">Select Genre:</label>
            <select id="genreSelect" style="padding: 10px; border: 2px solid #FF9800; border-radius: 8px; font-size: 14px; font-weight: 600; background: white; cursor: pointer; width: 200px;">
              <option value="Classical">Classical</option>
              <option value="Pop/Folk/Celtic">Pop/Folk/Celtic</option>
              <option value="Country">Country</option>
              <option value="Gospel">Gospel</option> 
            </select>
          </div>
          <div class="library-grid" id="libraryGrid">
            <!-- Populated by JS -->
          </div>
        </div>

        <div class="upload-section" id="uploadSection">
          <label class="upload-label" id="uploadLabel">
            üì§ Upload Your Own Songs (MP3)
          </label>
          <input type="file" id="customSongUpload" accept=".mp3,audio/mpeg" multiple style="display: none;">
          <div style="margin-top: 8px; font-size: 13px; color: #666;">
            <span id="songCountDisplay">0 songs selected</span>
          </div>
        </div>
        
        <div class="form-group">
          <label>Your Selected Songs (max 6 total). Click ‚Äúup‚Äù or ‚Äúdown‚Äù arrows to change song order.</label>
          <div id="songList" class="song-list">
            <!-- Populated by JS -->
          </div>
        </div>
        
      <!-- SECTION 3: Video Timing -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">‚è±Ô∏è</span>
          <span class="section-title">Video Timing</span>
        </div>

        <div class="form-group">
          <label>How should we time your video?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="timingMode" value="perSlide">
              <span class="radio-option-label">Per Slide Duration</span>
              <div class="radio-option-content">
                <span class="radio-option-desc">Set how many seconds each slide should display</span>
                <div class="conditional-input" id="perSlideInput" style="display:none;">
                  <label for="perSlideSec" style="font-size: 13px; margin-bottom: 6px;">Seconds per slide:</label>
                  <input type="number" id="perSlideSec" name="perSlideSec" min="2" max="30" value="5">
                </div>
              </div>
            </label>
            
            <label class="radio-option selected">
              <input type="radio" name="timingMode" value="fixedRuntime" checked>
              <span class="radio-option-label">Fixed Total Runtime</span>
              <div class="radio-option-content">
                <span class="radio-option-desc">Set the total video length in seconds (recommended)</span>
                <div class="conditional-input" id="fixedRuntimeInput">
                  <label for="fixedRuntimeSec" style="font-size: 13px; margin-bottom: 6px;">Total runtime (seconds):</label>
                  <input type="number" id="fixedRuntimeSec" name="fixedRuntimeSec" min="30" max="1800" value="350">
                </div>
              </div>
            </label>
            
            <label class="radio-option">
              <input type="radio" name="timingMode" value="fitToSongs">
              <span class="radio-option-label">Fit to Music Length</span>
              <div class="radio-option-content">
                <span class="radio-option-desc">Video duration matches your music (automatic)</span>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Duration Display -->
      <div id="durationDisplay" class="preview-section" style="display:none; background: #e8f5e9; border-color: #4CAF50; margin-top: 20px;">
        <div class="preview-header" style="color: #2e7d32;">
         ‚è±Ô∏è Estimated Video Duration
       </div>
       <div style="padding: 15px; background: white; border-radius: 8px;">
         <div style="font-size: 32px; font-weight: 700; color: #4CAF50; text-align: center;" id="durationValue">
           --:--
         </div>
         <div style="font-size: 14px; color: #666; text-align: center; margin-top: 8px;" id="durationDetails">
           Enter slide count to calculate
         </div>
       </div>
     </div>
      
      <!-- SECTION 4: Transitions -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üé®</span>
          <span class="section-title">Transition Style</span>
        </div>

        <div class="transition-container">
          <!-- Left side: Dropdown -->
          <div class="transition-dropdown">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="visualPackage">
                Visual Package
                <div class="help-text">Choose the style of transitions between slides</div>
              </label>
              <select id="visualPackage" name="visualPackage">
                <option value="simple-fade-wipe">Simple Fade & Wipe</option>
                <option value="pages-of-life">Pages of Life</option>
                <option value="floating-frames">Floating Frames</option>
                <option value="zoom-through">Zoom Through</option>
                <option value="blinds-combs-bars">Blinds, Combs & Bars</option>
              </select>
            </div>
          </div>
          
          <!-- Right side: Video Preview -->
          <div class="transition-preview">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555; font-size: 14px;">
              Preview
            </label>
            <div style="background: #000; border-radius: 8px; overflow: hidden;">
              <video id="transitionPreview" controls preload="metadata" playsinline style="width: 100%; display: block;">
                <source id="transitionPreviewSource" src="https://www.dropbox.com/scl/fi/ij0b9ndn9mcg2me0ipb7y/Transition-Examples-Simple-Fade-and-Wipe-2.mp4?rlkey=pgrt4ad1qg3wy9203pv6c32zm&st=j9cme2mi&raw=1" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SECTION 5: Music Distribution -->
      <div class="section">
        <div class="section-header">
          <span class="section-icon">üéº</span>
          <span class="section-title">Music Distribution</span>
        </div>
        
        <div class="form-group">
          <label for="musicDistribution">
            How should songs be distributed?
            <div class="help-text">Choose how your selected songs play throughout the video</div>
          </label>
          <select id="musicDistribution" name="musicDistribution">
            <option value="evenlyDistributed">Evenly Distributed (Recommended)</option>
            <option value="specifyPlacement">Specify Placement (Advanced)</option>
          </select>
        </div>

        <!-- Conditional Song Range Sliders -->
        <div id="songRangesContainer" class="song-ranges-container" style="display:none;">
          <div class="info-box">
            üìç Specify which slides each song should play during. The backend will automatically prevent overlaps and fill gaps.
          </div>
          <div id="songRangesList">
            <!-- Will be populated dynamically based on number of songs -->
          </div>
        </div>
      </div>
      
      <!-- SUBMIT SECTION -->
      <div class="submit-section">
        <button id="submitBtn" class="btn-submit" onclick="calculateVideo()" disabled>
          üìä Review My Video Plan (Submit)
        </button>
        
        <p class="submit-note" style="color: #667eea;">
          We'll calculate your video length and show you a preview before creating it
        </p>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- NEW CALCULATION MODAL GOES HERE -->
  <div id="calculationModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä Your Current Video Plan</h2>
      </div>
      
      <div class="modal-body">
        <div class="calc-result-item">
          <span class="calc-label">Slide Count:</span>
          <span class="calc-value" id="modalSlideCount">--</span>
        </div>
        
        <div class="calc-result-item">
          <span class="calc-label">Estimated Duration:</span>
          <span class="calc-value" id="modalDuration">--</span>
        </div>
        
        <div class="calc-summary" id="modalSummary">
          Calculating...
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeCalculationModal()">
          ‚Üê Make Another Update
        </button>
        <button class="modal-btn modal-btn-primary" onclick="finalSubmit()">
          Create This Video ‚úì
        </button>
      </div>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">Creating Your Video...</div>
      <div class="loading-subtext">Please wait, this may take a few moments</div>
    </div>
  </div>

  <!-- Music Upload Terms Modal -->
  <div id="musicTermsModal" class="terms-modal-overlay">
    <div class="terms-modal-content">
      <div class="terms-modal-header">
        <h2>‚ö†Ô∏è User Uploaded Music</h2>
      </div>
    
      <div class="terms-modal-body">
        <p>By clicking "Agree and Accept," you confirm that you have the legal right to upload and publicly display all content (including photos, videos, and music) in your memorial video.</p>
      
        <p>You agree that Memorial Video AI is not responsible for any copyright or other legal issues arising from content you upload, and you will protect and reimburse Memorial Video AI for any claims, costs, or damages (including legal fees) that result from your uploaded content violating someone else's rights.</p>
      </div>
    
      <div class="terms-modal-footer">
        <button class="terms-btn terms-btn-cancel" onclick="cancelMusicUpload()">
          Cancel Upload
        </button>
        <button class="terms-btn terms-btn-accept" onclick="acceptMusicTerms()">
          Agree and Accept
        </button>
      </div>
    </div>
  </div>
      
  <script>
    // Configuration
    const API_ENDPOINT = 'https://p273y4lw2j.execute-api.us-east-2.amazonaws.com/prod/process-job';
    const S3_UPLOAD_API = 'https://4hyy6kr2id.execute-api.us-east-2.amazonaws.com/prod/generate-upload-url';
    const CALCULATE_API = 'https://4hyy6kr2id.execute-api.us-east-2.amazonaws.com/prod/jobs';
    const MAX_SONGS = 6;
    
    // Song Library
    // Song Library with S3 URLs
    const SONG_LIBRARY = [
      {
        id: 'abandoned-house-115974',
        name: 'abandoned-house-115974.mp3',
        displayName: 'Abandoned House - Violin | S. Pavkin | 4:32',
        genre: 'Classical',
        duration: '4:32',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/abandoned-house-115974.mp3'
      },
      {
        id: 'ave-maria-instrumental-150536',
        name: 'ave-maria-instrumental-150536.mp3',
        displayName: 'Ave Maria - instrumental | J. Monter | 4:30',
        genre: 'Classical',
        duration: '4:30',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/ave-maria-instrumental-150536.mp3'
      },
      {
        id: 'drowning-echoes-dramatic-orchestra-345956',
        name: 'drowning-echoes-dramatic-orchestra-345956.mp3',
        displayName: 'Drowning Echoes | L. Timachev | 1:35',
        genre: 'Classical',
        duration: '1:35',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/drowning-echoes-dramatic-orchestra-345956.mp3'
      },
      {
        id: 'farewell-to-w-111721',
        name: 'farewell-to-w-111721.mp3',
        displayName: 'Farwell to W | Jan Semmler| 1:56',
        genre: 'Classical',
        duration: '1:56',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/farewell-to-w-111721.mp3'
      },
      {
        id: 'funeral-165257',
        name: 'funeral-165257.mp3',
        displayName: 'Funeral | A. Chubarova | 1:39',
        genre: 'Classical',
        duration: '1:39',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/funeral-165257.mp3'
      },
      {
        id: 'funeral-memories-piano-334314',
        name: 'funeral-memories-piano-334314.mp3',
        displayName: 'Funeral Memories - Piano | O. F. Music | 2:10',
        genre: 'Classical',
        duration: '2:10',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/funeral-memories-piano-334314.mp3'
      },
      {
        id: 'lullaby-for-you-391546',
        name: 'lullaby-for-you-391546.mp3',
        displayName: 'Lullaby for You | Loli Valiente (v) | 3:10',
        genre: 'Pop/Folk/Celtic',
        duration: '3:10',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/lullaby-for-you-391546.mp3'
      },
      {
        id: 'beethoven-sonata-no14-op-27-moonlight-sonata-14237',
        name: 'beethoven-sonata-no14-op-27-moonlight-sonata-14237.mp3',
        displayName: 'Moonlight Sonata | Beethoven | 5:25',
        genre: 'Classical',
        duration: '5:25',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/beethoven-sonata-no14-op-27-moonlight-sonata-14237.mp3'
      },
      {
        id: 'pachelbelx27s-canon-canon-in-d-307319',
        name: 'pachelbelx27s-canon-canon-in-d-307319.mp3',
        displayName: 'Pachelbel\'s Canon (in D) | C. Clavier | 2:41',
        genre: 'Classical',
        duration: '2:41',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/pachelbelx27s-canon-canon-in-d-307319.mp3'
      },
      {
        id: 'pathetique-sonata-beethoven-350778',
        name: 'pathetique-sonata-beethoven-350778.mp3',
        displayName: 'Pathetique Sonata - Beethoven | J. Chauvel | 5:03',
        genre: 'Classical',
        duration: '5:03',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/pathetique-sonata-beethoven-350778.mp3'
      },
      {
        id: 'chopin-prelude-in-e-minor-165243',
        name: 'chopin-prelude-in-e-minor-165243.mp3',
        displayName: 'Prelude in e-minor | Chopin | 1:55',
        genre: 'Classical',
        duration: '1:55',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/chopin-prelude-in-e-minor-165243.mp3'
      },
      {
        id: 'remember-116568',
        name: 'remember-116568.mp3',
        displayName: 'Remember | Sergii Pavkin | 3:52',
        genre: 'Classical',
        duration: '3:52',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/remember-116568.mp3'
      },
      {
        id: 'sad-moment-sad-and-melancholy-piano-background-music-124488',
        name: 'sad-moment-sad-and-melancholy-piano-background-music-124488.mp3',
        displayName: 'Sad Moment | Oleg Fedak | 2:39',
        genre: 'Classical',
        duration: '2:39',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/sad-moment-sad-and-melancholy-piano-background-music-124488.mp3'
      },
      {
        id: 'sad-violin-150146',
        name: 'sad-violin-150146.mp3',
        displayName: 'Sad Violin | A. Chubarova | 1:56',
        genre: 'Classical',
        duration: '1:56',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/sad-violin-150146.mp3'
      },
      {
        id: 'country-background-349052',
        name: 'country-background-349052.mp3',
        displayName: 'Country Background - acoustic | T. Tank | 2:03',
        genre: 'Country',
        duration: '2:03',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/country-background-349052.mp3'
      },
      {
        id: 'country-rodeo-cowboy-ballad-music-full-351039',
        name: 'country-rodeo-cowboy-ballad-music-full-351039.mp3',
        displayName: 'Country Ballad - acoustic | U. Catch | 3:27',
        genre: 'Country',
        duration: '3:27',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/country-rodeo-cowboy-ballad-music-full-351039.mp3'
      },
      {
        id: 'dust-and-memory-420131',
        name: 'dust-and-memory-420131.mp3',
        displayName: 'Dust and Memory - acoustic | S. Koushik | 3:02',
        genre: 'Country',
        duration: '3:02',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/dust-and-memory-420131.mp3'
      },
      {
        id: 'empty-chair-at-the-table-250271',
        name: 'empty-chair-at-the-table-250271.mp3',
        displayName: 'Empty Chair at the Table (v) | T. Keiji | 3:26',
        genre: 'Country',
        duration: '3:26',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/empty-chair-at-the-table-250271.mp3'
      },
      {
        id: 'hands-to-heaven-318378',
        name: 'hands-to-heaven-318378.mp3',
        displayName: 'Hands to Heaven (v) | T. Keiji | 3:41',
        genre: 'Country',
        duration: '3:41',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/hands-to-heaven-318378.mp3'
      },
      {
        id: 'i-only-loved-lucy-243840',
        name: 'i-only-loved-lucy-243840.mp3',
        displayName: 'I Only Loved Lucy - acoustic | Alan Jordan | 1:51',
        genre: 'Country',
        duration: '1:51',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/i-only-loved-lucy-243840.mp3'
      },
      {
        id: 'meet-you-in-texas-243843',
        name: 'meet-you-in-texas-243843.mp3',
        displayName: 'I\'ll Meet You in Texas - guitar | Alan Jordan | 3:10',
        genre: 'Country',
        duration: '3:10',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/meet-you-in-texas-243843.mp3'
      },
      {
        id: 'in-god-we-trust-307905',
        name: 'in-god-we-trust-307905.mp3',
        displayName: 'In God We Trust (v) | Phill Buck | 4:00',
        genre: 'Country',
        duration: '4:00',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/in-god-we-trust-307905.mp3'
      },
      {
        id: 'instrumental-music-acoustic-country-193189',
        name: 'instrumental-music-acoustic-country-193189.mp3',
        displayName: 'Instrumental Acoustic Country | T. Lam | 4:12',
        genre: 'Country',
        duration: '4:12',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/instrumental-music-acoustic-country-193189.mp3'
      },
      {
        id: 'Acoustic-mix-gospel-worship-400470',
        name: 'Acoustic-mix-gospel-worship-400470.mp3',
        displayName: 'Accoustic Mix Gospel Worship | A. Poraddovsky | 5:08',
        genre: 'Gospel',
        duration: '5:08',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/Acoustic-mix-gospel-worship-400470.mp3'
      },
      {
        id: 'gospel-worship-amazing-grace-347221',
        name: 'gospel-worship-amazing-grace-347221.mp3',
        displayName: 'Amazing Grace (v) | TuneTank | 5:39',
        genre: 'Gospel',
        duration: '5:39',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/gospel-worship-amazing-grace-347221.mp3'
      },
      {
        id: 'ave-maria-vocal-417992',
        name: 'ave-maria-vocal-417992.mp3',
        displayName: 'Ave Maria (v) | N. Panek | 3:31',
        genre: 'Gospel',
        duration: '3:31',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/ave-maria-vocal-417992.mp3'
      },
      {
        id: 'cathedral-164234',
        name: 'cathedral-164234.mp3',
        displayName: 'Cathedral - Choir | A. Chubarova  | 1:25',
        genre: 'Gospel',
        duration: '1:25',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/cathedral-164234.mp3'
      },
      {
        id: 'gospel-ballad-boys-choir-humming-4216',
        name: 'gospel-ballad-boys-choir-humming-4216.mp3',
        displayName: 'Gospel Ballad Boys Choir | Juliius H. | 4:06',
        genre: 'Gospel',
        duration: '4:06',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/gospel-ballad-boys-choir-humming-4216.mp3'
      },
      {
        id: 'gospel-worship-christian-church-music-323163',
        name: 'gospel-worship-christian-church-music-323163.mp3',
        displayName: 'Gospel Worship | L. Poltavskyi | 2:13',
        genre: 'Gospel',
        duration: '2:13',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/gospel-worship-christian-church-music-323163.mp3'
      },
      {
        id: 'voices-of-eternity-church-cathedral-choir-195196',
        name: 'voices-of-eternity-church-cathedral-choir-195196.mp3',
        displayName: 'Voices of Eternity - Choir | Natalia | 2:34',
        genre: 'Gospel',
        duration: '2:34',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/voices-of-eternity-church-cathedral-choir-195196.mp3'
      },
      {
        id: 'you-restore-my-soul-413723',
        name: 'you-restore-my-soul-413723.mp3',
        displayName: 'You Restore My Soul (v) | J. Haryanto | 2:56',
        genre: 'Gospel',
        duration: '2:56',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/you-restore-my-soul-413723.mp3'
      },
      {
        id: 'across-the-oceans-269104',
        name: 'across-the-oceans-269104.mp3',
        displayName: 'Across the Oceans (v) | D. Ram | 3:49',
        genre: 'Pop/Folk/Celtic',
        duration: '3:49',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/across-the-oceans-269104.mp3'
      },
      {
        id: 'eulogy-ambient-piano-196437',
        name: 'eulogy-ambient-piano-196437.mp3',
        displayName: 'Eulogy - Ambient Piano | Liderc | 1:15',
        genre: 'Pop/Folk/Celtic',
        duration: '1:15',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/eulogy-ambient-piano-196437.mp3'
      },
      {
        id: 'farewell-full-of-love-346874',
        name: 'farewell-full-of-love-346874.mp3',
        displayName: 'Farewell Full Of Love (v) | E. Wyns | 3:46',
        genre: 'Pop/Folk/Celtic',
        duration: '3:46',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/farewell-full-of-love-346874.mp3'
      },
      {
        id: 'heart-of-the-highlands-celtic-342779',
        name: 'heart-of-the-highlands-celtic-342779.mp3',
        displayName: 'Heart of the Highlands - Celtic | P. Winter | 4:24',
        genre: 'Pop/Folk/Celtic',
        duration: '4:24',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/heart-of-the-highlands-celtic-342779.mp3'
      },
      {
        id: 'heartbroken-winter-instrumental-306095',
        name: 'heartbroken-winter-instrumental-306095.mp3',
        displayName: 'Heartbroken Winter - instrumental | S. Koushik | 3:22',
        genre: 'Pop/Folk/Celtic',
        duration: '3:22',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/heartbroken-winter-instrumental-306095.mp3'
      },
      {
        id: 'instrumental-pop-339552',
        name: 'instrumental-pop-339552.mp3',
        displayName: 'Instrumental Pop  | J. January | 3:39',
        genre: 'Pop/Folk/Celtic',
        duration: '3:39',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/instrumental-pop-339552.mp3'
      },
      {
        id: 'ki-instrumental-ambient-337501',
        name: 'ki-instrumental-ambient-337501.mp3',
        displayName: 'KI - Instrumental Ambient | S. Wurtz | 2:51',
        genre: 'Pop/Folk/Celtic',
        duration: '2:51',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/ki-instrumental-ambient-337501.mp3'
      },
      {
        id: 'life-with-you-297782',
        name: 'life-with-you-297782.mp3',
        displayName: 'Life With You - instrumental | M. Dembitsky | 2:20',
        genre: 'Pop/Folk/Celtic',
        duration: '2:20',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/life-with-you-297782.mp3'
      },
      {
        id: 'sad-song-326267',
        name: 'sad-song-326267.mp3',
        displayName: 'Sad Song | R. Dutta | 3:57',
        genre: 'Pop/Folk/Celtic',
        duration: '3:57',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/sad-song-326267.mp3'
      },
      {
        id: 'emerald-isles-celtic-342785',
        name: 'emerald-isles-celtic-342785.mp3',
        displayName: 'The Emerald Isles - Celtic | P. Winter | 3:26',
        genre: 'Pop/Folk/Celtic',
        duration: '3:26',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/emerald-isles-celtic-342785.mp3'
      },
      {
        id: 'the-hands-that-loved-me-301869',
        name: 'the-hands-that-loved-me-301869.mp3',
        displayName: 'The Hands that Loved Me (v) | S. Evans | 2:38',
        genre: 'Pop/Folk/Celtic',
        duration: '2:38',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/the-hands-that-loved-me-301869.mp3'
      },
      {
        id: 'tomorrow-144278',
        name: 'tomorrow-144278.mp3',
        displayName: 'Tomorrow - instrumental | H. Jeon | 2:06',
        genre: 'Pop/Folk/Celtic',
        duration: '2:06',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/tomorrow-144278.mp3'
      },
      {
        id: 'today-we-are-tomorrow-we-fade-1-312133',
        name: 'today-we-are-tomorrow-we-fade-1-312133.mp3',
        displayName: 'Tomorrow we Fade (v) | Jetty Jan | 3:06',
        genre: 'Pop/Folk/Celtic',
        duration: '3:06',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/today-we-are-tomorrow-we-fade-1-312133.mp3'
      }
    ];

    // Transition preview video mapping
    const TRANSITION_VIDEOS = {
      'simple-fade-wipe': 'https://www.dropbox.com/scl/fi/368hwkwqhtks5v9e3j1es/Transition-Examples-Simple-Fade-and-Wipe-3.mp4?rlkey=nvwfk02kf55096zyoquc85u3c&st=9deaz85e&dl=1',
      'pages-of-life': 'https://www.dropbox.com/scl/fi/o285ltxtsrpqws5gvaw3h/Transition-Examples-Pages-of-Life-2.mp4?rlkey=xkhdb1oa8wd0m46vgewi3gp9f&st=zv8vokof&raw=1',
      'floating-frames': 'https://www.dropbox.com/scl/fi/l7ifvko5rdumtp2ssa1cb/Transition-Examples-Floating-Frames-2.mp4?rlkey=seyficxdrpnu9vmg63ydbw09i&st=lgbll6sa&raw=1',
      'zoom-through': 'https://www.dropbox.com/scl/fi/xbochmmlgl0v430lo7l6q/Transition-Examples-Zoom-Through-2.mp4?rlkey=kkgfphukmjg2sa8m69egd36nq&st=9hr8hm8c&raw=1',
      'blinds-combs-bars': 'https://www.dropbox.com/scl/fi/yu49ywzg9lnpfvbkpngun/Transition-Examples-Blinds-Combs-Bars-2.mp4?rlkey=itoxqenf61i2cm746kvn2fjbl&st=wk0xl254&raw=1'
    };
    
    // Mobile detection helper
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
        || window.innerWidth <= 768;
    }
    
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get('uid');
    const email = urlParams.get('email');
    const customerFirstName = urlParams.get('customerFirstName') || 'there';
    const firstName = urlParams.get('firstName') || 'there';
    const fullName = urlParams.get('fullName') || '';
    const slideshowUrl = urlParams.get('slideshowUrl') || '';
    const dropboxUrl = urlParams.get('dropboxUrl') || '';
    
    // State
    let selectedSongs = [];
    let currentlyPlayingAudio = null;
    let songRanges = [];
    
    // Initialize
    if (!uid || !email) {
      showToast('Missing required parameters in URL', 'error');
    } else {
      initializePage();
    }
    
    function initializePage() {
      // Set up slideshow preview
      setupSlideshowPreview();

      // Update header with deceased person's name if available
      if (firstName && firstName !== '' && firstName !== 'there') {
        document.getElementById('headerTitle').textContent = `‚ú® Customize Memorial Video for ${firstName}`;
        document.title = `Memorial Video for ${fullName}`;
      }
      
      // Render song library
      renderLibrary();
      renderSongList();
      updateSongCount();
      
      // Setup event listeners
      setupEventListeners();
      
      // Validate form
      validateForm();
    }
    
function setupSlideshowPreview() {
  const iframe = document.getElementById('previewIframe');
  const urlDisplay = document.getElementById('previewUrl');
  const previewSection = document.getElementById('slideshowPreview');
  const previewHeader = document.getElementById('previewHeader');

  // Grab the slideshow URL from query params
  const urlParams = new URLSearchParams(window.location.search);
  const slideshowUrl = urlParams.get('slideshowUrl');

  if (slideshowUrl) {
    let embedUrl = slideshowUrl;

    // === GOOGLE SLIDES HANDLING ===
    if (slideshowUrl.includes('docs.google.com/presentation')) {
      embedUrl = slideshowUrl.replace('/edit', '/embed');

      previewHeader.textContent = 'üîç Preview: Original Google Slides';
      previewSection.style.display = 'block';
      iframe.src = embedUrl;
      document.getElementById('editSlidesButton').href = slideshowUrl;
    }

    // === POWERPOINT / ONEDRIVE / SHAREPOINT HANDLING ===
    else if (
      slideshowUrl.includes('sharepoint.com') ||
      slideshowUrl.includes('onedrive.live.com') ||
      slideshowUrl.includes('1drv.ms')
    ) {
      previewHeader.textContent = 'üîç Preview: Original PowerPoint';
      previewSection.style.display = 'block';
      
      if (isMobileDevice()) {
        // Mobile: Show "tap to view" button instead of embed
        const iframeContainer = iframe.parentElement;
        iframe.style.display = 'none';
        
        const existingButton = iframeContainer.querySelector('.mobile-preview-btn');
        if (!existingButton) {
          const mobileButton = document.createElement('a');
          mobileButton.href = slideshowUrl;
          mobileButton.target = '_blank';
          mobileButton.className = 'mobile-preview-btn';
          mobileButton.style.cssText = `
            display: block; 
            padding: 40px; 
            background: white; 
            border: 2px solid #90caf9; 
            border-radius: 8px; 
            text-align: center; 
            text-decoration: none; 
            color: #1565c0;
            font-weight: 600; 
            font-size: 16px;
            margin: 10px 0;
          `;
          mobileButton.innerHTML = 'üì± Tap to View PowerPoint in New Tab';
          iframeContainer.appendChild(mobileButton);
        }
      } else {
        // Desktop: Use embed
        iframe.style.display = 'block';
        const existingButton = iframe.parentElement.querySelector('.mobile-preview-btn');
        if (existingButton) existingButton.remove();
        
        let embedUrl = slideshowUrl;
        if (!slideshowUrl.includes('action=embedview')) {
          const separator = slideshowUrl.includes('?') ? '&' : '?';
          embedUrl = slideshowUrl + separator + 'action=embedview&wdStartOn=1&em=2';
        }
        iframe.src = embedUrl;
      }
      
      document.getElementById('editSlidesButton').href = slideshowUrl;
      console.log('[PREVIEW] PowerPoint setup complete');
    }
  } 
}
    
    function setupEventListeners() {
      // Slideshow version radio buttons
      document.querySelectorAll('input[name="slideshowVersion"]').forEach(radio => {
        radio.addEventListener('change', handleSlideshowVersionChange);
      });
      
      // PowerPoint method radio buttons (file vs URL)
      document.querySelectorAll('input[name="pptxMethod"]').forEach(radio => {
        radio.addEventListener('change', handlePptxMethodChange);
      });
      
      // New Google Slides URL input - update preview on input
      document.getElementById('newGoogleSlidesUrl').addEventListener('input', (e) => {
        const selectedVersion = document.querySelector('input[name="slideshowVersion"]:checked').value;
        if (selectedVersion === 'copy') {
          updateCopyPreview(e.target.value);
        }
        validateForm();
      });
      
      // PowerPoint URL input - update preview on input
      document.getElementById('pptxUrl').addEventListener('input', (e) => {
        const selectedVersion = document.querySelector('input[name="slideshowVersion"]:checked').value;
        if (selectedVersion === 'download') {
          updatePowerPointUrlPreview(e.target.value);
        }
        validateForm();
      });
      
      // PowerPoint file upload - show filename
      document.getElementById('pptxFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const selectedVersion = document.querySelector('input[name="slideshowVersion"]:checked').value;
        
        if (file && selectedVersion === 'download') {
          document.getElementById('pptxFileName').textContent = file.name;
          document.getElementById('pptxFilePreview').style.display = 'block';
          document.getElementById('slideshowPreview').style.display = 'none';
        }
        validateForm();
      });
      
      // Timing mode radio buttons
      document.querySelectorAll('input[name="timingMode"]').forEach(radio => {
        radio.addEventListener('change', handleTimingModeChange);
      });
      
      // Custom song upload
      document.getElementById('uploadLabel').addEventListener('click', showMusicTermsModal);
      document.getElementById('customSongUpload').addEventListener('change', handleCustomSongUpload);
      
      // Form changes
      document.querySelectorAll('select, input').forEach(element => {
        element.addEventListener('change', validateForm);
        element.addEventListener('input', validateForm);
      });

      // Music distribution change handler
      document.getElementById('musicDistribution').addEventListener('change', (e) => {
        const value = e.target.value;
        handleMusicDistributionChange(value);
      });

      // Duration calculator triggers
      document.getElementById('perSlideSec').addEventListener('input', calculateVideoDuration);
      document.getElementById('fixedRuntimeSec').addEventListener('input', calculateVideoDuration);
      
      // Submit button
      document.getElementById('submitBtn').addEventListener('click', calculateVideo);
    }
    
    function handleSlideshowVersionChange(e) {
      const value = e.target.value;
      console.log('[DEBUG] Slideshow version changed to:', value);
  
      // Update radio option selected class
      document.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      e.target.closest('.radio-option').classList.add('selected');
  
      // Show/hide conditional inputs
      const copyInput = document.getElementById('copyUrlInput');
      const downloadInput = document.getElementById('downloadInput');
  
      console.log('[DEBUG] copyUrlInput element:', copyInput);
      console.log('[DEBUG] downloadInput element:', downloadInput);
  
      copyInput.style.display = value === 'copy' ? 'block' : 'none';
      downloadInput.style.display = value === 'download' ? 'block' : 'none';
  
      console.log('[DEBUG] copyUrlInput display:', copyInput.style.display);
      console.log('[DEBUG] downloadInput display:', downloadInput.style.display);
      
      // Handle preview visibility
      const slideshowPreview = document.getElementById('slideshowPreview');
      const pptxFilePreview = document.getElementById('pptxFilePreview');
      const iframe = document.getElementById('previewIframe');
      const urlDisplay = document.getElementById('previewUrl');
      const previewHeader = document.getElementById('previewHeader');
      
      // Hide all previews first
      slideshowPreview.style.display = 'none';
      pptxFilePreview.style.display = 'none';
      
      if (value === 'original') {
        // Show original slideshow preview
        if (slideshowUrl) {
          let embedUrl = slideshowUrl;
          if (slideshowUrl.includes('docs.google.com/presentation')) {
            embedUrl = slideshowUrl.replace('/edit', '/embed');
            previewHeader.textContent = 'üîç Preview: Original Slideshow';
            document.getElementById('editSlidesButton').href = slideshowUrl;
          } else if (slideshowUrl.includes('onedrive.live.com') || slideshowUrl.includes('sharepoint.com') || slideshowUrl.includes('1drv.ms')) {
          previewHeader.textContent = 'üîç Preview: Original PowerPoint';
          
          if (isMobileDevice()) {
            // Mobile: Show button
            iframe.style.display = 'none';
            const iframeContainer = iframe.parentElement;
            const existingButton = iframeContainer.querySelector('.mobile-preview-btn');
            if (!existingButton) {
              const mobileButton = document.createElement('a');
              mobileButton.href = slideshowUrl;
              mobileButton.target = '_blank';
              mobileButton.className = 'mobile-preview-btn';
              mobileButton.style.cssText = `
                display: block; 
                padding: 40px; 
                background: white; 
                border: 2px solid #90caf9; 
                border-radius: 8px; 
                text-align: center; 
                text-decoration: none; 
                color: #1565c0;
                font-weight: 600; 
                font-size: 16px;
                margin: 10px 0;
              `;
              mobileButton.innerHTML = 'üì± Tap to View PowerPoint in New Tab';
              iframeContainer.appendChild(mobileButton);
            }
          } else {
            // Desktop: Use embed
            iframe.style.display = 'block';
            const existingButton = iframe.parentElement.querySelector('.mobile-preview-btn');
            if (existingButton) existingButton.remove();
            
            let embedUrl = slideshowUrl;
            if (!slideshowUrl.includes('action=embedview')) {
              const separator = slideshowUrl.includes('?') ? '&' : '?';
              embedUrl = slideshowUrl + separator + 'action=embedview&wdStartOn=1&em=2';
            } else {
              embedUrl = slideshowUrl;
            }
            iframe.src = embedUrl;
          }
          
          document.getElementById('editSlidesButton').href = slideshowUrl;
          slideshowPreview.style.display = 'block';
        }
        }
      } else if (value === 'copy') {
        // Preview will update when user enters URL (handled in input event listener)
        const newUrl = document.getElementById('newGoogleSlidesUrl').value;
        if (newUrl) {
          updateCopyPreview(newUrl);
        }
      } else if (value === 'download') {
        // Check if file is uploaded
        const pptxFile = document.getElementById('pptxFile').files[0];
        const pptxUrl = document.getElementById('pptxUrl').value;
        
        if (pptxFile) {
          document.getElementById('pptxFileName').textContent = pptxFile.name;
          pptxFilePreview.style.display = 'block';
        } else if (pptxUrl) {
          updatePowerPointUrlPreview(pptxUrl);
        }
      }
      
      validateForm();
    }

    function handlePptxMethodChange(e) {
      const value = e.target.value;
      const fileSection = document.getElementById('pptxFileSection');
      const urlSection = document.getElementById('pptxUrlSection');
      const pptxFilePreview = document.getElementById('pptxFilePreview');
      const slideshowPreview = document.getElementById('slideshowPreview');
      
      // Hide both sections and previews first
      fileSection.style.display = 'none';
      urlSection.style.display = 'none';
      pptxFilePreview.style.display = 'none';
      slideshowPreview.style.display = 'none';
      
      // Clear the opposite field
      if (value === 'file') {
        fileSection.style.display = 'block';
        document.getElementById('pptxUrl').value = '';
      } else if (value === 'url') {
        urlSection.style.display = 'block';
        document.getElementById('pptxFile').value = '';
      }
      
      validateForm();
    }
    
    function updateCopyPreview(url) {
      const slideshowPreview = document.getElementById('slideshowPreview');
      const iframe = document.getElementById('previewIframe');
      const previewHeader = document.getElementById('previewHeader');

      // Hide first
      slideshowPreview.style.display = 'none';

      if (url && url.includes('docs.google.com/presentation')) {
        // --- Google Slides embed ---
        const embedUrl = url.replace('/edit', '/embed');
        previewHeader.textContent = 'üîç Preview: Your Google Slides Copy';
        iframe.src = embedUrl;
        document.getElementById('editSlidesButton').href = url;
        slideshowPreview.style.display = 'block';
      } else if (url && (url.includes('sharepoint.com') || url.includes('onedrive.live.com') || url.includes('1drv.ms'))) {
        previewHeader.textContent = 'üîç Preview: Your PowerPoint Copy';
        
        if (isMobileDevice()) {
          // Mobile: Show button
          const iframeContainer = iframe.parentElement;
          iframe.style.display = 'none';
          
          let existingButton = iframeContainer.querySelector('.mobile-preview-btn');
          if (existingButton) {
            existingButton.href = url;
          } else {
            const mobileButton = document.createElement('a');
            mobileButton.href = url;
            mobileButton.target = '_blank';
            mobileButton.className = 'mobile-preview-btn';
            mobileButton.style.cssText = `
              display: block; 
              padding: 40px; 
              background: white; 
              border: 2px solid #90caf9; 
              border-radius: 8px; 
              text-align: center; 
              text-decoration: none; 
              color: #1565c0;
              font-weight: 600; 
              font-size: 16px;
              margin: 10px 0;
            `;
            mobileButton.innerHTML = 'üì± Tap to View PowerPoint in New Tab';
            iframeContainer.appendChild(mobileButton);
          }
        } else {
          // Desktop: Use embed
          iframe.style.display = 'block';
          const existingButton = iframe.parentElement.querySelector('.mobile-preview-btn');
          if (existingButton) existingButton.remove();
          
          let embedUrl = url;
          if (!url.includes('action=embedview')) {
            const separator = url.includes('?') ? '&' : '?';
            embedUrl = url + separator + 'action=embedview&wdStartOn=1&em=2';
          }
          iframe.src = embedUrl;
        }
        
        document.getElementById('editSlidesButton').href = url;
        slideshowPreview.style.display = 'block';
        console.log('[PREVIEW] PowerPoint copy preview updated');
      }
      } else {
        slideshowPreview.style.display = 'none';
      }
    }

    
    function updatePowerPointUrlPreview(url) {
      const slideshowPreview = document.getElementById('slideshowPreview');
      const pptxFilePreview = document.getElementById('pptxFilePreview');
      const iframe = document.getElementById('previewIframe');
      const previewHeader = document.getElementById('previewHeader');

      slideshowPreview.style.display = 'none';
      pptxFilePreview.style.display = 'none';

      if (url && (url.includes('sharepoint.com') || url.includes('onedrive.live.com') || url.includes('1drv.ms'))) {
        previewHeader.textContent = 'üîç Preview: PowerPoint (Online)';
        
        if (isMobileDevice()) {
          // Mobile: Show button
          const iframeContainer = iframe.parentElement;
          iframe.style.display = 'none';
          
          let existingButton = iframeContainer.querySelector('.mobile-preview-btn');
          if (existingButton) {
            existingButton.href = url;
          } else {
            const mobileButton = document.createElement('a');
            mobileButton.href = url;
            mobileButton.target = '_blank';
            mobileButton.className = 'mobile-preview-btn';
            mobileButton.style.cssText = `
              display: block; 
              padding: 40px; 
              background: white; 
              border: 2px solid #90caf9; 
              border-radius: 8px; 
              text-align: center; 
              text-decoration: none; 
              color: #1565c0;
              font-weight: 600; 
              font-size: 16px;
              margin: 10px 0;
            `;
            mobileButton.innerHTML = 'üì± Tap to View PowerPoint in New Tab';
            iframeContainer.appendChild(mobileButton);
          }
        } else {
          // Desktop: Use embed
          iframe.style.display = 'block';
          const existingButton = iframe.parentElement.querySelector('.mobile-preview-btn');
          if (existingButton) existingButton.remove();
          
          let embedUrl = url;
          if (!url.includes('action=embedview')) {
            const separator = url.includes('?') ? '&' : '?';
            embedUrl = url + separator + 'action=embedview&wdStartOn=1&em=2';
          }
          iframe.src = embedUrl;
        }
        
        document.getElementById('editSlidesButton').href = url;
        slideshowPreview.style.display = 'block';
        console.log('[PREVIEW] PowerPoint URL preview updated');
      }
    }
    
    function handleTimingModeChange(e) {
      const value = e.target.value;
      
      // Update radio option selected class
      document.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      e.target.closest('.radio-option').classList.add('selected');
      
      // Show/hide conditional inputs
      document.getElementById('perSlideInput').style.display = value === 'perSlide' ? 'block' : 'none';
      document.getElementById('fixedRuntimeInput').style.display = value === 'fixedRuntime' ? 'block' : 'none';

      calculateVideoDuration();
      validateForm();
    }
    
    function renderLibrary() {
      const container = document.getElementById('libraryGrid');
      const selectedGenre = document.getElementById('genreSelect').value;
  
      // Filter songs by selected genre
      const filteredSongs = SONG_LIBRARY.filter(song => song.genre === selectedGenre);
      
      let html = '';
      filteredSongs.forEach(song => {
        const isAdded = selectedSongs.some(s => s.id === song.id);
        const cardClass = isAdded ? 'library-song-card added' : 'library-song-card';
        const btnClass = isAdded ? 'btn-add-library added' : 'btn-add-library';
        const btnText = isAdded ? '‚úì Added' : '+ Add Song';
        const audioId = `audio-lib-${song.id}`;
        
        html += `
          <div class="${cardClass}" data-song-id="${song.id}">
            <div class="library-song-name">${song.displayName}</div>
            <div class="library-song-controls">
              <button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">‚ñ∂Ô∏è Play Song</button>
              <button class="${btnClass}" onclick="addLibrarySong('${song.id}')" ${isAdded || selectedSongs.length >= MAX_SONGS ? 'disabled' : ''}>
                ${btnText}
              </button>
            </div>
            <audio id="${audioId}" src="${song.url}" preload="none"></audio>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function addLibrarySong(songId) {
      if (selectedSongs.length >= MAX_SONGS) {
        showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
        return;
      }
      
      const libSong = SONG_LIBRARY.find(s => s.id === songId);
      if (!libSong) return;
      
      if (selectedSongs.some(s => s.id === songId)) {
        showToast('Song already added', 'error');
        return;
      }
      
      selectedSongs.push({
        id: libSong.id,
        name: libSong.name,
        displayName: libSong.displayName,
        url: libSong.url,
        isLibrary: true,
        file: null,
        duration: libSong.duration
      });
      
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
      validateForm();
      showToast(`Added "${libSong.displayName}"`, 'success');
    }
    
    function renderSongList() {
      const container = document.getElementById('songList');
      
      if (selectedSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic; padding: 20px; text-align: center;">No songs selected. Choose from the library above or upload your own!</div>';
        return;
      }
      
      let html = '';
      selectedSongs.forEach((song, index) => {
        const audioId = `audio-${song.id}`;
        const badge = song.isLibrary ? '<span class="song-badge library">LIBRARY</span>' : '<span class="song-badge">CUSTOM</span>';
        const itemClass = song.isLibrary ? 'song-item library-song' : 'song-item new-upload';
        
        html += `
          <div class="${itemClass}">
            <div class="song-info">
              <div class="song-position">${index + 1}</div>
              <span class="song-name">${song.displayName}</span>
              ${badge}
            </div>
            <div class="song-controls">
              ${song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">‚ñ∂Ô∏è Play Song</button>` : ''}
              <button class="btn-small btn-move" onclick="moveSongUp(${index})" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è Move Up</button>
              <button class="btn-small btn-move" onclick="moveSongDown(${index})" ${index === selectedSongs.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è Move Down</button>
              <button class="btn-small btn-danger" onclick="removeSong(${index})">üóëÔ∏è</button>
            </div>
            ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function togglePlay(audioId, button) {
      const audio = document.getElementById(audioId);
      
      if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio.currentTime = 0;
        document.querySelectorAll('.btn-play').forEach(btn => {
          btn.textContent = '‚ñ∂Ô∏è';
          btn.classList.remove('playing');
        });
      }
      
      if (audio.paused) {
        audio.play();
        button.textContent = '‚è∏Ô∏è';
        button.classList.add('playing');
        currentlyPlayingAudio = audio;
        
        audio.onended = () => {
          button.textContent = '‚ñ∂Ô∏è';
          button.classList.remove('playing');
          currentlyPlayingAudio = null;
        };
      } else {
        audio.pause();
        audio.currentTime = 0;
        button.textContent = '‚ñ∂Ô∏è';
        button.classList.remove('playing');
        currentlyPlayingAudio = null;
      }
    }
    
    function moveSongUp(index) {
      if (index === 0) return;
      const temp = selectedSongs[index];
      selectedSongs[index] = selectedSongs[index - 1];
      selectedSongs[index - 1] = temp;
      renderSongList();
      updateSongRangeSliders();
      calculateVideoDuration();
    }
    
    function moveSongDown(index) {
      if (index === selectedSongs.length - 1) return;
      const temp = selectedSongs[index];
      selectedSongs[index] = selectedSongs[index + 1];
      selectedSongs[index + 1] = temp;
      renderSongList();
      updateSongRangeSliders();
      calculateVideoDuration();
    }
    
    function removeSong(index) {
      if (!confirm(`Remove "${selectedSongs[index].displayName}"?`)) return;
      selectedSongs.splice(index, 1);
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
      validateForm();
    }
    
    function updateSongCount() {
      const display = document.getElementById('songCountDisplay');
      const uploadSection = document.getElementById('uploadSection');
      const uploadLabel = document.getElementById('uploadLabel');
      
      display.textContent = `${selectedSongs.length} songs selected`;
      
      if (selectedSongs.length >= MAX_SONGS) {
        uploadSection.classList.add('max-reached');
        uploadLabel.classList.add('disabled');
      } else {
        uploadSection.classList.remove('max-reached');
        uploadLabel.classList.remove('disabled');
      }
    }

    function calculateVideoDuration() {
      // Function disabled - slideCount input was removed
      return;
  
      const slideCountInput = document.getElementById('slideCount');
      const slideCount = parseInt(slideCountInput.value);
      const timingMode = document.querySelector('input[name="timingMode"]:checked')?.value;
  
      const displayDiv = document.getElementById('durationDisplay');
      const valueDiv = document.getElementById('durationValue');
      const detailsDiv = document.getElementById('durationDetails');
  
      // Hide if no slide count
      if (!slideCount || slideCount < 2) {
        displayDiv.style.display = 'none';
        return;
      }
  
      let totalSeconds = 0;
      let detailsText = '';
  
      if (timingMode === 'perSlide') {
        const perSlideSec = parseInt(document.getElementById('perSlideSec').value) || 5;
        // (slideCount - 2) normal slides + 2 slides at 2x duration
        totalSeconds = (slideCount - 2) * perSlideSec + (2 * perSlideSec * 2);
  
        // Format time for display in the message
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
        detailsText = `Video will be ${timeDisplay} long with ${slideCount} slides at ${perSlideSec} seconds per slide (beginning and end slide at ${perSlideSec * 2}s)`;
  
      } else if (timingMode === 'fixedRuntime') {
        totalSeconds = parseInt(document.getElementById('fixedRuntimeSec').value) || 350;
        const avgPerSlide = Math.round(totalSeconds / slideCount);
  
        // Format time for display in the message
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
        detailsText = `Video will be ${timeDisplay} long across ${slideCount} slides at approximately ${avgPerSlide} seconds per slide`;
  
      } else if (timingMode === 'fitToSongs') {
        // Sum all song durations
        totalSeconds = selectedSongs.reduce((sum, song) => {
          return sum + (song.duration || 0);
      }, 0);
  
      if (totalSeconds === 0) {
        detailsText = 'Add songs to calculate duration';
        displayDiv.style.display = 'none';
        return;
      }
  
      const avgPerSlide = Math.round(totalSeconds / slideCount);
      const songWord = selectedSongs.length === 1 ? 'song' : 'songs';
  
      // Format time for display in the message
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
      detailsText = `Video will be ${timeDisplay} long based on ${selectedSongs.length} selected ${songWord} at ${avgPerSlide} seconds per slide (beginning and end slide at ${avgPerSlide * 2}s)`;
    }
  
      // Format as MM:SS
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
      valueDiv.textContent = formattedTime;
      detailsDiv.textContent = detailsText;
      displayDiv.style.display = 'block';
    }
    
    function handleCustomSongUpload(e) {
      const files = Array.from(e.target.files);
  
      files.forEach(file => {
        if (selectedSongs.length >= MAX_SONGS) {
          showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
          return;
        }
    
        if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {
          showToast(`${file.name} is not an MP3 file`, 'error');
          return;
        }
    
        const localUrl = URL.createObjectURL(file);
    
        // Create audio element to get duration
        const audio = new Audio(localUrl);
        audio.addEventListener('loadedmetadata', () => {
          const duration = Math.round(audio.duration);
      
          // Find the song in selectedSongs and update its duration
          const song = selectedSongs.find(s => s.url === localUrl);
          if (song) {
            song.duration = duration;
            console.log(`[DURATION] ${file.name}: ${duration}s`);
            calculateVideoDuration(); // Recalculate after getting duration
          }
        });
    
        selectedSongs.push({
          id: `custom-${Date.now()}-${Math.random()}`,
          name: file.name,
          displayName: file.name,
          url: localUrl,
          isLibrary: false,
          file: file,
          duration: null // Will be set when metadata loads
        });
      });
  
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
      validateForm();
  
      e.target.value = '';
    }
    // Genre selector change event listener
    document.getElementById('genreSelect').addEventListener('change', () => {
      renderLibrary();
    });

    // Update transition preview when selection changes
    document.getElementById('visualPackage').addEventListener('change', (e) => {
      const selectedValue = e.target.value;
      const videoSource = document.getElementById('transitionPreviewSource');
      const video = document.getElementById('transitionPreview');
      
      if (selectedValue && TRANSITION_VIDEOS[selectedValue]) {
        videoSource.src = TRANSITION_VIDEOS[selectedValue];
        video.load();
      }
    });
    
    function validateForm() {
      const slideshowVersion = document.querySelector('input[name="slideshowVersion"]:checked').value;
      const submitBtn = document.getElementById('submitBtn');
      
      let isValid = true;
      
      // Check slideshow
      if (slideshowVersion === 'copy') {
        const newUrl = document.getElementById('newGoogleSlidesUrl').value;
        if (!newUrl || !newUrl.includes('docs.google.com/presentation')) {
          isValid = false;
        }
      } else if (slideshowVersion === 'download') {
        const pptxFile = document.getElementById('pptxFile').files[0];
        const pptxUrl = document.getElementById('pptxUrl').value;
        if (!pptxFile && !pptxUrl) {
          isValid = false;
        }
      }
      
      // Check songs
      if (selectedSongs.length === 0) {
        isValid = false;
      }

      // Check song ranges if Specify Placement is selected
      const musicDistribution = document.getElementById('musicDistribution').value;
      if (musicDistribution === 'specifyPlacement' && selectedSongs.length > 0) {
        for (let i = 0; i < selectedSongs.length; i++) {
          const startInput = document.getElementById(`songRange${i}Start`);
          const endInput = document.getElementById(`songRange${i}End`);
    
          if (!startInput || !endInput || !startInput.value || !endInput.value) {
            isValid = false;
            break;
          }
    
          const start = parseInt(startInput.value);
          const end = parseInt(endInput.value);
    
          if (start < 1 || end < 1 || start > end) {
            isValid = false;
            break;
          }
        }
      }
      
      submitBtn.disabled = !isValid;
    }

    // Handle music distribution change
    function handleMusicDistributionChange(value) {
      const container = document.getElementById('songRangesContainer');
      
      if (value === 'specifyPlacement') {
        container.style.display = 'block';
        setupSongRangeSliders();
      } else {
        container.style.display = 'none';
      }
    }
    
    // Setup song range sliders
    function setupSongRangeSliders() {
      const container = document.getElementById('songRangesList');

    if (selectedSongs.length === 0) {
      container.innerHTML = '<div style="color: #999; font-style: italic;">No songs available. Add songs first.</div>';
      return;
    }

    let html = '';
    let exampleStart = 1;
    let exampleEnd = 19;
  
    selectedSongs.forEach((song, index) => {
      const audioId = `audio-range-${song.id}`;
      const playButton = song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)" style="margin-left: 8px;">‚ñ∂Ô∏è Play Song</button>` : '';

      // Auto-populate start value: first song starts at 1, others start at previous end + 1
      const startValue = index === 0 ? '1' : '';
    
      // Calculate example placeholders
      const startPlaceholder = `Example: ${exampleStart}`;
      const endPlaceholder = `Example: ${exampleEnd}`;

      html += `
        <div class="song-range-item">
        <div class="song-range-header">
          üéµ ${song.displayName}
          ${playButton}
          ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
        </div>
        <div class="slide-inputs">
          <div class="slide-input-group">
            <label>Start Slide</label>
            <input type="number" 
                   id="songRange${index}Start" 
                   class="song-range-input"
                   data-song-index="${index}"
                   data-type="start"
                   min="1" 
                   max="250" 
                   value="${startValue}"
                   placeholder="${startPlaceholder}">
          </div>
          <div class="slide-input-group">
            <label>End Slide</label>
            <input type="number" 
                   id="songRange${index}End" 
                   class="song-range-input"
                  data-song-index="${index}"
                   data-type="end"
                   min="1" 
                   max="250" 
                  placeholder="${endPlaceholder}">
         </div>
        </div>
      </div>
    `;
  
    // Update examples for next song
    exampleStart = exampleEnd + 1;
    exampleEnd = exampleStart + 17; // Each song spans about 18 slides in examples
    });
  
    container.innerHTML = html;
  
    // Add event listeners to all range inputs
    document.querySelectorAll('.song-range-input').forEach(input => {
      input.addEventListener('input', handleSongRangeChange);
    });
  }
    
    // Handle song range input changes
    function handleSongRangeChange(e) {
      const changedIndex = parseInt(e.target.dataset.songIndex);
      const changedType = e.target.dataset.type;
  
      // If an "End Slide" changed, update the next song's start slide
      if (changedType === 'end' && changedIndex < selectedSongs.length - 1) {
        const endValue = parseInt(e.target.value);
        if (!isNaN(endValue)) {
          const nextStartInput = document.getElementById(`songRange${changedIndex + 1}Start`);
          if (nextStartInput) {
            nextStartInput.value = endValue + 1;
          }
        }
      }
  
      // Rebuild songRanges array
      songRanges = [];

      selectedSongs.forEach((song, index) => {
        const startInput = document.getElementById(`songRange${index}Start`);
        const endInput = document.getElementById(`songRange${index}End`);

        if (startInput && endInput) {
          const startVal = parseInt(startInput.value);
          const endVal = parseInt(endInput.value);
  
          if (!isNaN(startVal) && !isNaN(endVal)) {
            let songIdentifier;
    
            if (song.isLibrary) {
              // Library: use actual filename
              songIdentifier = song.name;
            } else {
              // Custom: use position-based name (matches backend upload order)
              songIdentifier = `song${index + 1}.mp3`;
            }
    
            songRanges.push({
              song: songIdentifier,
              startSlide: startVal,
              endSlide: endVal
            });
         }
      }
    });

    console.log('[SONG RANGES]', songRanges);
    validateForm();
  }
    // Update song range sliders when song count changes
    function updateSongRangeSliders() {
      const musicDist = document.getElementById('musicDistribution').value;
      if (musicDist === 'specifyPlacement') {
        setupSongRangeSliders();
      }
    }

    async function calculateVideo() {
      try {
        showLoading(true, 'Reviewing Video Plan...', 'Counting slides and estimating duration');
        
        // STEP 1: Determine presentation type and source
        const slideshowVersion = document.querySelector('input[name="slideshowVersion"]:checked').value;
        let presentationType = null;
        let presentationSource = null;
        
        if (slideshowVersion === 'original') {
          if (slideshowUrl.includes('docs.google.com/presentation')) {
            presentationType = 'google_slides';
            presentationSource = slideshowUrl;
          } else if (slideshowUrl.includes('sharepoint.com') || slideshowUrl.includes('onedrive.live.com') || slideshowUrl.includes('1drv.ms')) {
            presentationType = 'powerpoint_url';
            presentationSource = slideshowUrl;
          } else {
            throw new Error('Could not determine presentation type from original URL');
          }
        } else if (slideshowVersion === 'copy') {
          const newUrl = document.getElementById('newGoogleSlidesUrl').value;
          presentationType = 'google_slides';
          presentationSource = newUrl;
        } else if (slideshowVersion === 'download') {
          const pptxFile = document.getElementById('pptxFile').files[0];
          const pptxUrl = document.getElementById('pptxUrl').value;
          
          if (pptxFile) {
            // Upload file to S3 first
            showToast('Uploading presentation...', 'success');
            const uploadedUrl = await uploadFileToS3(pptxFile, 'presentation');
            presentationType = 'powerpoint_file';
            presentationSource = uploadedUrl;
          } else if (pptxUrl) {
            presentationType = 'powerpoint_url';
            presentationSource = pptxUrl;
          }
        }
        
        if (!presentationType || !presentationSource) {
          throw new Error('Could not determine presentation type');
        }
        
        // STEP 2: Call calculate API to get slide count
        showToast('Counting slides...', 'success');
        const calculatePayload = {
          presentationType: presentationType,
          presentationSource: presentationSource
        };
        
        console.log('[CALCULATE] Calling API:', `${CALCULATE_API}/${uid}/calculate`);
        console.log('[CALCULATE] Payload:', calculatePayload);
        
        const calculateResponse = await fetch(`${CALCULATE_API}/${uid}/calculate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(calculatePayload)
        });
        
        if (!calculateResponse.ok) {
          const errorData = await calculateResponse.json().catch(() => ({}));
          throw new Error(errorData.error || `Failed to calculate: HTTP ${calculateResponse.status}`);
        }
        
        const calculateResult = await calculateResponse.json();
        console.log('[CALCULATE] Result:', calculateResult);
        
        const slideCount = calculateResult.slideCount;
        
        // STEP 3: Calculate duration based on timing mode and songs
        const timingMode = document.querySelector('input[name="timingMode"]:checked').value;
        let estimatedSeconds = 0;
        let durationText = '';
        let summaryText = '';
        
        // Calculate total music duration
        let totalMusicSeconds = 0;
        for (const song of selectedSongs) {
          let songSeconds = 0;
  
          if (typeof song.duration === 'string') {
            // Library song: convert "4:32" to seconds
            const parts = song.duration.split(':');
            songSeconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
          } else if (typeof song.duration === 'number') {
            // Custom uploaded song: already in seconds
            songSeconds = song.duration;
          } else {
            // No duration yet (custom song still loading): default 3 min
            songSeconds = 180;
          }
  
          totalMusicSeconds += songSeconds;
        }
        
        if (timingMode === 'fixedRuntime') {
          estimatedSeconds = parseInt(document.getElementById('fixedRuntimeSec').value) || 350;
          const minutes = Math.floor(estimatedSeconds / 60);
          const seconds = estimatedSeconds % 60;
          durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          // Calculate time range (¬± 9 seconds)
          const minSeconds = Math.max(0, estimatedSeconds - 9);
          const maxSeconds = estimatedSeconds + 9;
          const minMinutes = Math.floor(minSeconds / 60);
          const minSecs = minSeconds % 60;
          const maxMinutes = Math.floor(maxSeconds / 60);
          const maxSecs = maxSeconds % 60;
          const minTime = `${minMinutes}:${minSecs.toString().padStart(2, '0')}`;
          const maxTime = `${maxMinutes}:${maxSecs.toString().padStart(2, '0')}`;
          
          const perSlide = (estimatedSeconds / slideCount).toFixed(1);
          
          // Get visual package and music distribution
          const visualPackage = document.getElementById('visualPackage').value;
          const visualPackageNames = {
            'simple-fade-wipe': 'Simple Fade & Wipe',
            'pages-of-life': 'Pages of Life',
            'floating-frames': 'Floating Frames',
            'zoom-through': 'Zoom Through',
            'blinds-combs-bars': 'Blinds, Combs & Bars'
          };
          const visualName = visualPackageNames[visualPackage] || visualPackage;
          
          const musicDistribution = document.getElementById('musicDistribution').value;
          const distributionNames = {
            'evenlyDistributed': 'Evenly Distributed',
            'specifyPlacement': 'Specify Placement'
          };
          const distributionName = distributionNames[musicDistribution] || 'Evenly Distributed';
          
          const songCount = selectedSongs.length;
          const songText = songCount === 1 ? '1 song' : `${songCount} songs`;
          
          summaryText = `The video between ${minTime} and ${maxTime} uses Fixed Runtime mode with ${slideCount} slides (approximately ${perSlide} seconds per slide), ${visualName} transitions, and ${songText} (${distributionName}).`;
          
        } else if (timingMode === 'perSlide') {
          const perSlide = parseInt(document.getElementById('perSlideSec').value) || 5;
          estimatedSeconds = (slideCount * perSlide) + (perSlide * 2);
          const minutes = Math.floor(estimatedSeconds / 60);
          const seconds = estimatedSeconds % 60;
          durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          // Calculate time range (¬± 9 seconds)
          const minSeconds = Math.max(0, estimatedSeconds - 9);
          const maxSeconds = estimatedSeconds + 9;
          const minMinutes = Math.floor(minSeconds / 60);
          const minSecs = minSeconds % 60;
          const maxMinutes = Math.floor(maxSeconds / 60);
          const maxSecs = maxSeconds % 60;
          const minTime = `${minMinutes}:${minSecs.toString().padStart(2, '0')}`;
          const maxTime = `${maxMinutes}:${maxSecs.toString().padStart(2, '0')}`;
          
          // Get visual package and music distribution
          const visualPackage = document.getElementById('visualPackage').value;
          const visualPackageNames = {
            'simple-fade-wipe': 'Simple Fade & Wipe',
            'pages-of-life': 'Pages of Life',
            'floating-frames': 'Floating Frames',
            'zoom-through': 'Zoom Through',
            'blinds-combs-bars': 'Blinds, Combs & Bars'
          };
          const visualName = visualPackageNames[visualPackage] || visualPackage;
          
          const musicDistribution = document.getElementById('musicDistribution').value;
          const distributionNames = {
            'evenlyDistributed': 'Evenly Distributed',
            'specifyPlacement': 'Specify Placement'
          };
          const distributionName = distributionNames[musicDistribution] || 'Evenly Distributed';
          
          const songCount = selectedSongs.length;
          const songText = songCount === 1 ? '1 song' : `${songCount} songs`;
          
          summaryText = `The video between ${minTime} and ${maxTime} uses Per Slide Duration mode with ${slideCount} slides at ${perSlide} seconds per slide, ${visualName} transitions, and ${songText} (${distributionName}).`;
       
        } else if (timingMode === 'fitToSongs') {
          estimatedSeconds = totalMusicSeconds;
          const minutes = Math.floor(estimatedSeconds / 60);
          const seconds = estimatedSeconds % 60;
          durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          // Calculate time range (¬± 9 seconds)
          const minSeconds = Math.max(0, estimatedSeconds - 9);
          const maxSeconds = estimatedSeconds + 9;
          const minMinutes = Math.floor(minSeconds / 60);
          const minSecs = minSeconds % 60;
          const maxMinutes = Math.floor(maxSeconds / 60);
          const maxSecs = maxSeconds % 60;
          const minTime = `${minMinutes}:${minSecs.toString().padStart(2, '0')}`;
          const maxTime = `${maxMinutes}:${maxSecs.toString().padStart(2, '0')}`;
          
          const perSlide = (estimatedSeconds / slideCount).toFixed(1);
          
          // Get visual package
          const visualPackage = document.getElementById('visualPackage').value;
          const visualPackageNames = {
            'simple-fade-wipe': 'Simple Fade & Wipe',
            'pages-of-life': 'Pages of Life',
            'floating-frames': 'Floating Frames',
            'zoom-through': 'Zoom Through',
            'blinds-combs-bars': 'Blinds, Combs & Bars'
          };
          const visualName = visualPackageNames[visualPackage] || visualPackage;
          
          const songCount = selectedSongs.length;
          const songText = songCount === 1 ? '1 song' : `${songCount} songs`;
          
          summaryText = `The video between ${minTime} and ${maxTime} uses Fit to Music Length mode with ${slideCount} slides (approximately ${perSlide} seconds per slide), ${visualName} transitions, and ${songText} (automatically distributed to match music length).`;
        }
        
        showLoading(false);
        
        // STEP 4: Show modal with results
        showCalculationModal(slideCount, durationText, summaryText);
        
      } catch (error) {
        console.error('[CALCULATE ERROR]', error);
        showLoading(false);
        showToast('Failed to calculate: ' + error.message, 'error');
      }
    }
    
    async function finalSubmit() {
      try {
        closeCalculationModal();
        showLoading(true);
        
        // STEP 1: Determine presentation type and source
        const slideshowVersion = document.querySelector('input[name="slideshowVersion"]:checked').value;
        let presentationType = null;
        let presentationSource = null;
        
        if (slideshowVersion === 'original') {
          if (slideshowUrl.includes('docs.google.com/presentation')) {
            presentationType = 'google_slides';
            presentationSource = slideshowUrl;
          } else if (slideshowUrl.includes('sharepoint.com') || slideshowUrl.includes('onedrive.live.com') || slideshowUrl.includes('1drv.ms')) {
            presentationType = 'powerpoint_url';
            presentationSource = slideshowUrl;
          } else {
            throw new Error('Could not determine presentation type from original URL');
          }
        } else if (slideshowVersion === 'copy') {
          const newUrl = document.getElementById('newGoogleSlidesUrl').value;
          presentationType = 'google_slides';
          presentationSource = newUrl;
        } else if (slideshowVersion === 'download') {
          const pptxFile = document.getElementById('pptxFile').files[0];
          const pptxUrl = document.getElementById('pptxUrl').value;
          
          if (pptxFile) {
            // Upload file to S3
            showToast('Uploading presentation...', 'success');
            const uploadedUrl = await uploadFileToS3(pptxFile, 'presentation');
            presentationType = 'powerpoint_file';
            presentationSource = uploadedUrl;
          } else if (pptxUrl) {
            presentationType = 'powerpoint_url';
            presentationSource = pptxUrl;
          }
        }
        
        if (!presentationType || !presentationSource) {
          throw new Error('Could not determine presentation type');
        }
        
        // STEP 2: Upload custom songs to S3 and collect all song URLs
        showToast('Uploading songs...', 'success');
        const songs = [];
        const songFilenames = [];  // ‚úÖ ADD THIS

        for (let i = 0; i < selectedSongs.length; i++) {
          const song = selectedSongs[i];
  
          if (song.isLibrary) {
            // Library song - use direct URL
            songs.push(song.url);
            songFilenames.push(song.name);  // ‚úÖ ADD THIS (original library filename)
          } else if (song.file) {
            // Custom song - upload to S3
            try {
              const uploadedUrl = await uploadFileToS3(song.file, 'song', i + 1);
              if (uploadedUrl) {
                songs.push(uploadedUrl);
                songFilenames.push(song.file.name);  // ‚úÖ ADD THIS (original uploaded filename)
              } else {
                throw new Error(`Failed to upload ${song.name} - no URL returned`);
              }
           } catch (error) {
             console.error(`[UPLOAD ERROR] Failed to upload song ${song.name}:`, error);
             showToast(`Failed to upload ${song.name}: ${error.message}`, 'error');
             throw new Error(`Song upload failed: ${song.name}`);
           }
        }
     }

     if (songs.length === 0) {
       throw new Error('No songs to process');
     }

     console.log(`[SONGS] Successfully prepared ${songs.length} songs`);
     console.log('[SONGS] URLs:', songs);
     console.log('[SONGS] Original filenames:', songFilenames);  // ‚úÖ ADD THIS
        
        // STEP 3: Build settings
        const timingMode = document.querySelector('input[name="timingMode"]:checked').value;
        const settings = {
          jobId: uid,
          customerEmail: email,
          timingMode: timingMode,
          visualPackage: document.getElementById('visualPackage').value,
          audioCount: songs.length,
          minPerSlideSec: 2,
          maxPerSlideSec: 12,
          targetLufs: -16,
          fadeInSec: 2,
          fadeOutSec: 2,
          musicDistribution: document.getElementById('musicDistribution').value,
          audioMatchPolicy: 'fitTo',
          fullName: fullName
        };
        
        if (timingMode === 'fixedRuntime') {
          settings.fixedRuntimeSec = parseInt(document.getElementById('fixedRuntimeSec').value) || 350;
        } else if (timingMode === 'perSlide') {
          settings.perSlideSec = parseInt(document.getElementById('perSlideSec').value) || 5;
        }

        // ADD SONG RANGES IF SPECIFY PLACEMENT IS SELECTED
        if (settings.musicDistribution === 'specifyPlacement' && songRanges.length > 0) {
          settings.songRanges = songRanges;
          console.log('[SUBMIT] Including songRanges:', songRanges);
        }
        
        // STEP 4: Build final payload
        const payload = {
          jobId: uid,
          customerFirstName: customerFirstName,
          customerLastName: '', 
          presentationType: presentationType,
          presentationSource: presentationSource,
          songs: songs,
          songFilenames: songFilenames,
          settings: settings
        };
        
        console.log('[SUBMIT] Payload:', JSON.stringify(payload, null, 2));
        
        // STEP 5: Submit to API
        showToast('Creating video...', 'success');
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[SUBMIT] Success:', result);
        
        showLoading(false);

        // Redirect to thank you page
        window.location.href = `thank-you.html?jobId=${encodeURIComponent(uid)}&email=${encodeURIComponent(email)}&name=${encodeURIComponent(customerFirstName)}`;
        
      } catch (error) {
        console.error('[SUBMIT ERROR]', error);
        showLoading(false);
        showToast('Failed to submit: ' + error.message, 'error');
      }
    }
    
    async function uploadFileToS3(file, fileType, fileNumber = null) {
      try {
        console.log(`[UPLOAD] Starting upload for ${file.name} (${fileType})`);
        
        // Get presigned URL from API
        const payload = {
          jobId: uid,
          fileType: fileType,
          fileExtension: file.name.split('.').pop()
        };
        
        if (fileNumber !== null) {
          payload.fileNumber = fileNumber;
        }
        
        console.log(`[UPLOAD] Requesting presigned URL with payload:`, payload);
        
        const urlResponse = await fetch(S3_UPLOAD_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!urlResponse.ok) {
          const errorText = await urlResponse.text();
          console.error(`[UPLOAD ERROR] Failed to get presigned URL: ${urlResponse.status} - ${errorText}`);
          throw new Error(`Failed to get upload URL: ${urlResponse.status} - ${errorText}`);
        }
        
        const responseData = await urlResponse.json();
        console.log(`[UPLOAD] Presigned URL response:`, responseData);
        
        const uploadUrl = responseData.uploadUrl;
        let s3Url = responseData.s3Url || responseData.s3Key;
        
        if (!uploadUrl) {
          throw new Error('No uploadUrl in API response');
        }
        
        console.log(`[UPLOAD] Got presigned URL, uploading to S3...`);
        
        // ‚úÖ FIXED CODE
        const uploadResponse = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': file.type
            // ACL header removed - files inherit bucket permissions
          },
          body: file
        });
        
        if (!uploadResponse.ok) {
          console.error(`[UPLOAD ERROR] S3 upload failed: ${uploadResponse.status}`);
          throw new Error(`S3 upload failed: ${uploadResponse.status}`);
        }
        
        // Convert S3 key to full URL if needed
        if (s3Url && !s3Url.startsWith('http')) {
          s3Url = `https://order-by-age-uploads.s3.us-east-2.amazonaws.com/${s3Url}`;
          console.log(`[UPLOAD] Converted S3 key to full URL: ${s3Url}`);
        }
        
        console.log(`[UPLOAD] Successfully uploaded ${file.name} to S3`);
        console.log(`[UPLOAD] S3 URL: ${s3Url}`);
        
        return s3Url;
      } catch (error) {
        console.error(`[UPLOAD ERROR] Failed to upload ${file.name}:`, error);
        throw error;
      }
    }
    
    function showLoading(show, message = 'Creating Your Video...', subtext = 'Please wait, this may take a few moments') {
      const overlay = document.getElementById('loadingOverlay');
  
      if (show) {
        document.querySelector('.loading-text').textContent = message;
        document.querySelector('.loading-subtext').textContent = subtext;
        overlay.classList.add('show');
      } else {
        overlay.classList.remove('show');
      }
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    function showCalculationModal(slideCount, duration, summary) {
      // Parse the duration (format: "M:SS")
      const parts = duration.split(':');
      const minutes = parseInt(parts[0]);
      const seconds = parseInt(parts[1]);
      const totalSeconds = (minutes * 60) + seconds;
      
      // Calculate range (¬± 9 seconds)
      const minSeconds = Math.max(0, totalSeconds - 9);
      const maxSeconds = totalSeconds + 9;
      
      // Convert back to M:SS format
      const minMinutes = Math.floor(minSeconds / 60);
      const minSecs = minSeconds % 60;
      const maxMinutes = Math.floor(maxSeconds / 60);
      const maxSecs = maxSeconds % 60;
      
      const minTime = `${minMinutes}:${minSecs.toString().padStart(2, '0')}`;
      const maxTime = `${maxMinutes}:${maxSecs.toString().padStart(2, '0')}`;
      
      const durationRange = `${minTime} - ${maxTime}`;
      
      document.getElementById('modalSlideCount').textContent = slideCount;
      document.getElementById('modalDuration').textContent = durationRange;
      document.getElementById('modalSummary').textContent = summary;
      document.getElementById('calculationModal').classList.add('show');
    }
    
    function closeCalculationModal() {
      document.getElementById('calculationModal').classList.remove('show');
    }
    
    let pendingMusicUpload = false;

    function showMusicTermsModal(e) {
      e.preventDefault();
      document.getElementById('musicTermsModal').classList.add('show');
    }

    function cancelMusicUpload() {
      document.getElementById('musicTermsModal').classList.remove('show');
      document.getElementById('customSongUpload').value = ''; // Clear file input
    }

    function acceptMusicTerms() {
      document.getElementById('musicTermsModal').classList.remove('show');
      // Trigger the file input
      document.getElementById('customSongUpload').click();
    }

    </script>
    </body>
    </html>
